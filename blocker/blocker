#!/bin/bash
#Install by "sudo cp blocker /usr/sbin;sudo touch /etc/blocker"

blst="/etc/blocker"
chmod 0777 $blst
path=`echo $PATH|sed 's/:/ /g'`

function permconv {
	permconv=0
	if [ ${1:1:1} == "r" ];then #-r--------
		permconv=`expr $permconv + 400`;fi
	if [ ${1:2:1} == "w" ];then #--w--------
		permconv=`expr $permconv + 200`;fi
	if [ ${1:3:1} == "x" ];then #---x------
		permconv=`expr $permconv + 100`
	elif [ ${1:3:1} == "s" ];then #---s------
		permconv=`expr $permconv + 4000`
	elif [ ${1:3:1} == "S" ];then #---S------
		permconv=`expr $permconv + 4100`;fi
	if [ ${1:4:1} == "r" ];then #----r-----
		permconv=`expr $permconv + 40`;fi
	if [ ${1:5:1} == "w" ];then #-----w----
		permconv=`expr $permconv + 20`;fi
	if [ ${1:6:1} == "x" ];then #------x---
		permconv=`expr $permconv + 10`
	elif [ ${1:6:1} == "s" ];then #------S---
		permconv=`expr $permconv + 2000`
	elif [ ${1:6:1} == "S" ];then #------S---
		permconv=`expr $permconv + 2010`;fi
	if [ ${1:7:1} == "r" ];then #-------r--
		permconv=`expr $permconv + 4`;fi
	if [ ${1:8:1} == "w" ];then #--------w-
		permconv=`expr $permconv + 2`;fi
	if [ ${1:9:1} == "x" ];then #---------x
		permconv=`expr $permconv + 1`
	elif [ ${1:9:1} == "t" ];then #---------t
		permconv=`expr $permconv + 1000`
	elif [ ${1:9:1} == "T" ];then #---------T
		permconv=`expr $permconv + 1001`;fi
	if [ ${#permconv} -lt 4 ]
	then
		permcount=`expr 4 - ${#permconv}`
		permconv=`printf "0%.0s" $(seq $permcount)`$permconv
	fi
	echo $permconv
}

if [ "$1" != "-b" ] && [ "$1" != "-a" ] && [ "$1" != "-l" ] && [ "$1" != "-ll" ] && [ "$1" != "-i" ]
then
	echo '''
 Application Blocker for Unix-like systems
  You can use this script to block any application.
  It -Simply- chmod 000 the application you want.
  Its returns its permissions when you "allow" it.
  Usage:
	-b [app] #to block any application
	-a [app] #to allow any blocked application
	-l       #to list all blocked applications
	-ll      #like previous but every application per line
	-i       #to install this application to your system
	any thing else #to show this help ;)		
'''	
fi

function list {
	if [ "$1" == "line" ]
	then
		cat $blst|sed 's/[ ].*//'|sed 's/\/.*\///'
	else
		blkapp=`cat $blst|sed 's/[ ].*//'|sed 's/\/.*\///'`
		echo $blkapp
	fi
}

for a in $@
do
	if [ "$a" == "-b" ]
	then
		case="block"
		continue
	elif [ "$a" == "-a" ]
	then
		case="allow"
		continue
	elif [ "$a" == "-l" ]
	then
		list
		continue
	elif [ "$a" == "-ll" ]
	then
		list line
		continue
	elif [ "$a" == "-i" ]
	then
		cp $0 /usr/sbin
		app=`echo $0|sed 's/.*\///'`
		chmod 0500 $app &>/dev/null
		echo "Blocker Installed"
		continue
	fi
	
	found=""
	for dir in $path
	do
		if [ -e "${dir}/${a}" ]
		then
			type=`ls -l "${dir}/${a}"|sed "s/[ ].*//"`
			if [ ${type:0:1} == "l" ]
			then
				link=`ls -l ${dir}/${a}|sed "s/.*[ ]//"`
				if [ ${link:0:1} != '/' ];then
					link="${dir}/${link}";fi
				if [ -e $link ];then
					found="$found $link";fi
			else
				found="$found $dir/$a"
			fi
		fi
	done
	if [ "$found" == "" ]
	then
		echo "$a not found"
		continue
	fi

	if [ "$case" == "block" ]
	then
		for file in $found
		do		
			if [ -e ${file} ];then
				mod=`permconv \`ls -l ${file}|sed "s/[ ].*//"\``;fi			
			if [ "$mod" == "0000" ]
			then
				echo "${file} is already blocked or have not any permissions"
			else
				killall -q ${file} 
				echo "${file} ${mod}" >> "$blst"
				chmod 000 $file
				echo blocked $file
			fi
		done
	elif [ "$case" == "allow" ]
	then
		for file in $found
		do
			if [ -e ${file} ];then
				mod=`permconv \`ls -l ${file}|sed "s/[ ].*//"\``;fi
					
			if [ "$mod" != "0000" ] || [ "`grep ${file} ${blst}`" == '' ]
			then
				echo "${file} is not blocked or not found in blocked list"
			else
				perm=`grep $file $blst|sed 's/.*[ ]//'`
				chmod $perm $file
				echo allowed $file
				file=${file//$'/'/$'\/'}
				sed "/$file/d" $blst > ${blst}.save
				mv ${blst}.save ${blst}
			fi
		done
	fi
done
chmod 0000 $blst
exit